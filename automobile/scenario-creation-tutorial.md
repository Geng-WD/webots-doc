## Scenario creation tutorial

This small tutorial explains step-by-step how to create a scenario inspired from a real world map and then add traffic using SUMO.
This tutorial was written for `linux` and `macOS`, but the same can be achieved on `Windows` converting the following commands to `DOS`.


### Creation of the Webots project directory

```sh
export WBT_PROJECT_PATH=/your/webots/project/path  # define here your project path
mkdir -p $WBT_PROJECT_PATH/worlds/myMap_net
```


### Download the OpenStreetMap map

We will use a part of the OpenStreetMap map to generate the Webots world file. To download the map go to the [OpenStreetMap website](https://www.openstreetmap.org/export). From there you can select the part of the map you want and download it:

%figure "Export a part of map from OpenStreetMap"
![osm_export.png](images/osm_export.png)
%end


### Generate the Webots world

As explained in the [OpenStreetMap importer](openstreetmap-importer.md) section, you should use the previously downloaded map to generate the Webots world.

> **Note**:
It is strongly recommended to not use the 3D feature of the [OpenStreetMap importer](openstreetmap-importer.md) otherwise it will not be possible to add traffic using SUMO.

```sh
cd $(WEBOTS_HOME)/projects/automobile/resources/OSM_importer
python importer.py --input=$WBT_PROJECT_PATH/worlds/myMap_net/myMap.osm --sumo-network-file=$WBT_PROJECT_PATH/worlds/myMap_net/sumo.net.xml --output=$WBT_PROJECT_PATH/worlds/myMap.wbt
```

> **Node**:
The `myMap.wbt` base name and the `myMap_net` directory prefix should match.

You should be able to open the generated world file directly in Webots:

%figure "resulting world generated by the importer"
![osm_tutorial_import1.png](images/osm_tutorial_import1.png)

![osm_tutorial_import2.png](images/osm_tutorial_import2.png)
%end

It is recommended at this stage to perform a manual check of the imported roads and crossroads,
to erase possible issues done by the importer.
A good strategy could be to fix the OSM data typically to add/remove wayPoints and import again the simulation.


### Generate the SUMO network files

We can also use the previously generated Webots world to generate the SUMO network file.
You need to use the [netconvert](http://sumo.dlr.de/wiki/NETCONVERT) utility for this:

```sh
cd $WEBOTS_HOME/projects/automobile/resources/SUMO_exporter
python exporter.py --input=$WBT_PROJECT_PATH/worlds/myMap.wbt --output=$WBT_PROJECT_PATH/worlds/myMap_net
$WEBOTS_HOME/projects/automobile/resources/bin/netconvert --node-files=$WBT_PROJECT_PATH/worlds/myMap_net/sumo.nod.xml --edge-files=$WBT_PROJECT_PATH/worlds/myMap_net/sumo.edg.xml --output-file=$WBT_PROJECT_PATH/worlds/myMap_net/sumo.net.xml
```

It is recommended at this stage to perform a manual check of the SUMO network file.
To do this, open the `sumo.net.xml` file in SUMO `netedit`:

```sh
$WEBOTS_HOME/projects/automobile/resources/bin/netedit $WBT_PROJECT_PATH/worlds/myMap_net/sumo.net.xml
```

You can then generate the route file, SUMO provides several ways to generate route files. You may for example generate a [flow file](http://sumo.dlr.de/wiki/Definition_of_Vehicles,_Vehicle_Types,_and_Routes) and then use [duarouter](http://sumo.dlr.de/wiki/DUAROUTER) to generate the route file for you:

```sh
$WEBOTS_HOME/projects/automobile/resources/bin/duarouter --flows $WBT_PROJECT_PATH/worlds/myMap_net/sumo.flow.xml --net-file $WBT_PROJECT_PATH/worlds/myMap_net/sumo.net.xml --output-file $WBT_PROJECT_PATH/worlds/myMap_net/sumo.rou.xml
```


### Add the SUMO interface

Now that you have all the required files, you can open the generated world in Webots and add the `SumoInterface` PROTO (or a `Supervisor` node and associate the `sumo_supervisor` controller to it). Since the network files are already generated, you need to set the `useNetconvert` field to FALSE (or use the `--noNetconvert` parameter) and set in the `networkfiles` field (or use the `--d or --directory` parameter) the path to the directory where the SUMO network files are located.
